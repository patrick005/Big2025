#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>

#define PIEZO_PORT PORTB
#define PIEZO_DDR  DDRB
#define PIEZO_PIN  _BV(PB7)

// 음계 주파수 (Hz) - 근사값
#define SOL4 392 // G4
#define LA4 440 // A4
#define SI4 494 // B4
#define DO5 523 // C5
#define RE5 587 // D5
#define MI5 659 // E5

// 음길이 (ms) - 4분음표 기준
#define WHOLE_NOTE 2000
#define HALF_NOTE 1000
#define QUARTER_NOTE 500
#define EIGHTH_NOTE 250

uint16_t doReMi[6] = {SOL4, LA4, SI4, DO5, RE5, MI5}; // 필요한 음계만 정의
uint8_t piano = 0;

// "My Soul" 멜로디 (악보 기반)
uint8_t melody[] = {
    0, 0, 1, 0, 5, 4, 3, // 1마디
    2, 3, 4, 5, 4, 3, 2, 1, // 2마디
    0, 0, 1, 0, 5, 4, 3, // 3마디
    2, 3, 4, 5, 4, 3, 2, 1, // 4마디
    0, 0, 1, 0, 5, 4, 3, // 5마디
    2, 3, 4, 5, 4, 3, 2, 1, // 6마디
    0, 0, 1, 0, 5, 4, 3, // 7마디
    2, 3, 4, 5, 4, 3, 2, 1, // 8마디
    0, 0, 1, 0, 5, 4, 3, // 9마디
    2, 3, 4, 5, 4, 3, 2, 1, // 10마디
    0, 0, 1, 0, 5, 4, 3, // 11마디
    2, 3, 4, 5, 4, 3, 2, 1, // 12마디
    0, 0, 1, 0, 5, 4, 3, // 13마디
    2, 3, 4, 5, 4, 3, 2, 1, // 14마디
    0, 0, 1, 0, 5, 4, 3, // 15마디
    2, 3, 4, 5, 4, 3, 2, 1, // 16마디
    0, 0, 1, 0, 5, 4, 3, // 17마디
    2, 3, 4, 5, 4, 3, 2, 1, // 18마디
    0, 0, 1, 0, 5, 4, 3, // 19마디
    2, 3, 4, 5, 4, 3, 2, 1, // 20마디
    0, 0, 1, 0, 5, 4, 3, // 21마디
    2, 3, 4, 5, 4, 3, 2, 1, // 22마디
    0, 0, 1, 0, 5, 4, 3, // 23마디
    2, 3, 4, 5, 4, 3, 2, 1, // 24마디
    0, 0, 1, 0, 5, 4, 3, // 25마디
    2, 3, 4, 5, 4, 3, 2, 1, // 26마디
    0, 0, 1, 0, 5, 4, 3, // 27마디
    2, 3, 4, 5, 4, 3, 2, 1, // 28마디
    0, 0, 1, 0, 5, 4, 3, // 29마디
    2, 3, 4, 5, 4, 3, 2, 1, // 30마디
    0, 0, 1, 0, 5, 4, 3, // 31마디
    2, 3, 4, 5, 4, 3, 2, 1, // 32마디
    0, 0, 1, 0, 5, 4, 3, // 33마디
    2, 3, 4, 5, 4, 3, 2, 1, // 34마디
    0, 0, 1, 0, 5, 4, 3, // 35마디
    2, 3, 4, 5, 4, 3, 2, 1, // 36마디
    0, 0, 1, 0, 5, 4, 3, // 37마디
    2, 3, 4, 5, 4, 3, 2, 1, // 38마디
    0, 0, 1, 0, 5, 4, 3, // 39마디
    2, 3, 4, 5, 4, 3, 2, 1, // 40마디
    0, 0, 1, 0, 5, 4, 3, // 41마디
    2, 3, 4, 5, 4, 3, 2, 1, // 42마디
    0, 0, 1, 0, 5, 4, 3, // 43마디
    2, 3, 4, 5, 4, 3, 2, 1, // 44마디
    0, 0, 1, 0, 5, 4, 3, // 45마디
    2, 3, 4, 5, 4, 3, 2, 1, // 46마디
    0, 0, 1, 0, 5, 4, 3, // 47마디
    2, 3, 4, 5, 4, 3, 2, 1, // 48마디
    0, 0, 1, 0, 5, 4, 3, // 49마디
    2, 3, 4, 5, 4, 3, 2, 1, // 50마디
    0, 0, 1, 0, 5, 4, 3, // 51마디
    2, 3, 4, 5, 4, 3, 2, 1, // 52마디
    0, 0, 1, 0, 5, 4, 3, // 53마디
    2, 3, 4, 5, 4, 3, 2, 1, // 54마디
    0, 0, 1, 0, 5, 4, 3, // 55마디
    2, 3, 4, 5, 4, 3, 2, 1, // 56마디
    0, 0, 1, 0, 5, 4, 3, // 57마디
    2, 3, 4, 5, 4, 3, 2, 1, // 58마디
    0, 0, 1, 0, 5, 4, 3, // 59마디
    2, 3, 4, 5, 4, 3, 2, 1  // 60마디
};

int main(void) {
    PIEZO_DDR |= PIEZO_PIN; // 버저 출력 설정

    TCCR1A = _BV(COM1C1) | _BV(WGM11); // Fast PWM, non-inverting mode
    TCCR1B = _BV(WGM13) | _BV(WGM12) | _BV(CS10); // Fast PWM, no prescaling
    TCCR1C = 0x00;

    sei(); // 전역 인터럽트 설정

    while (1) {
        ICR1 = 16000000 / doReMi[melody[piano]]; // 주파수 설정
        OCR1C = ICR1 / 2; // 듀티 사이클 50%

        // 음길이 처리 (4분음표 기준)
        _delay_ms(250); // 16분음표

        piano++;
        if (piano >= sizeof(melody) / sizeof(melody[0])) {
            piano = 0; // 멜로디 반복
        }
    }
    return 0;
}